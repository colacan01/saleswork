{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">작업 내용 입력</h2>

    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>작업 정보</h5>
            </div>
            <div class="card-body">
                {% for field in work_form %}
                <div class="mb-3 row">
                    <label for="{{ field.id_for_label }}" class="col-sm-2 col-form-label">{{ field.label }}</label>
                    <div class="col-sm-10">
                        {{ field }}
                        {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% if field.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in field.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>      
        
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>재료 정보</h5>
                <button type="button" id="add-material" class="btn btn-sm btn-primary">
                    + 재료 추가
                </button>
            </div>
            <div class="card-body">
                {{ material_formset.management_form }}
                
                <table class="table table-bordered" id="material-table">
                    <thead>
                        <tr>
                            <th style="width: 35%">재료명</th>
                            <th style="width: 15%">수량</th>
                            <th style="width: 20%">단가</th>
                            <th style="width: 20%">합계</th>
                            <th style="width: 10%">삭제</th>
                        </tr>
                    </thead>
                    <tbody id="material-tbody">
                        {% for form in material_formset %}
                        <tr class="material-form">
                            <td>
                                {{ form.product }}
                                {{ form.id }}
                                {% if form.product.errors %}
                                <div class="invalid-feedback d-block">{{ form.product.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                <div class="invalid-feedback d-block">{{ form.quantity.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.unit_price }}
                                {% if form.unit_price.errors %}
                                <div class="invalid-feedback d-block">{{ form.unit_price.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="form-control total-price" readonly>0</div>
                            </td>
                            <td class="text-center">
                                <div class="form-check">
                                    {{ form.DELETE }}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>결제 금액 정보</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-sm-2">
                        <label class="col-form-label">재료비</label>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-control" id="total-material-display" readonly>0</div>
                    </div>
                    <div class="col-sm-2">
                        <label class="col-form-label">공임</label>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-control" id="labor-cost-display" readonly>0</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-sm-2">
                        <label class="col-form-label fw-bold">총 결제 금액</label>
                    </div>
                    <div class="col-sm-10">
                        <h4 class="mb-0" id="grand-total-display">0원</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-success">저장하기</button>
            <a href="{% url 'work_item_list' %}" class="btn btn-secondary">취소</a>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 폼 관리 요소
        const totalFormsInput = document.querySelector('#id_materials-TOTAL_FORMS');
        const addMaterialBtn = document.querySelector('#add-material');
        
        // 재료비 입력란 (작업정보 섹션에 있는 필드)
        // 주의: 실제 재료비 입력 필드의 ID를 확인하고 수정하세요
        // const materialCostField = document.querySelector('#id_material_cost');
        
        // 페이지 로드 시 모든 행의 합계 계산
        calculateAllTotals();
        calculateTotalMaterialCost();
        updateGrandTotal();
        
        // 폼 추가 버튼 이벤트
        addMaterialBtn.addEventListener('click', function() {
            const currentFormCount = parseInt(totalFormsInput.value);
            
            // 기존 폼의 첫번째 요소를 복제
            const formRow = document.querySelector('.material-form').cloneNode(true);
            
            // 모든 입력 요소의 ID와 name 속성 업데이트
            const formElements = formRow.querySelectorAll('input, select');
            formElements.forEach(element => {
                if (element.id) {
                    element.id = element.id.replace(/-\d+-/, `-${currentFormCount}-`);
                }
                if (element.name) {
                    element.name = element.name.replace(/-\d+-/, `-${currentFormCount}-`);
                }
                // 입력 값 초기화
                if (element.type !== 'hidden' && element.type !== 'checkbox') {
                    element.value = '';
                }
                if (element.type === 'checkbox') {
                    element.checked = false;
                }
            });
            
            // 합계 초기화
            const totalElement = formRow.querySelector('.total-price');
            if (totalElement) {
                totalElement.textContent = '0';
            }
            
            // 오류 메시지 제거
            const errorElements = formRow.querySelectorAll('.invalid-feedback');
            errorElements.forEach(element => element.remove());
            
            // 새 폼 추가
            document.querySelector('#material-tbody').appendChild(formRow);
            
            // 총 폼 개수 업데이트
            totalFormsInput.value = currentFormCount + 1;
            
            // 전체 재료비 다시 계산
            calculateTotalMaterialCost();
        });
        
        // 삭제 체크박스 처리
        document.querySelector('#material-tbody').addEventListener('change', function(event) {
            if (event.target.type === 'checkbox' && event.target.name.includes('DELETE')) {
                const row = event.target.closest('tr');
                if (event.target.checked) {
                    row.style.textDecoration = 'line-through';
                    row.style.opacity = '0.5';
                } else {
                    row.style.textDecoration = 'none';
                    row.style.opacity = '1';
                }
                
                // 전체 재료비 다시 계산
                calculateTotalMaterialCost();
            }
        });

        // 수량 또는 단가 변경 시 합계 계산
        document.querySelector('#material-tbody').addEventListener('input', function(event) {
            if (event.target.name.includes('quantity') || event.target.name.includes('unit_price')) {
                const row = event.target.closest('tr');
                calculateRowTotal(row);
                calculateTotalMaterialCost();
                updateGrandTotal(); // 총 금액 업데이트 추가
            }
        });

        // 제품 선택시 단가 자동 설정
        document.querySelector('#material-tbody').addEventListener('change', function(event) {
            if (event.target.name.includes('product')) {
                const row = event.target.closest('tr');
                const productSelect = event.target;
                const unitPriceInput = row.querySelector('input[name$="-unit_price"]');
                
                if (productSelect.value) {
                    updateUnitPrice(productSelect);
                }
            }
        });

        // 공임 입력 필드에 이벤트 리스너 추가
        const laborCostField = document.querySelector('#id_labor_cost');
        if (laborCostField) {
            laborCostField.addEventListener('input', function() {
                updateGrandTotal();
            });
        }
        
        // 재료비 필드에 이벤트 리스너 추가
        const materialCostField = document.querySelector('#id_material_cost');
        if (materialCostField) {
            materialCostField.addEventListener('input', function() {
                updateGrandTotal();
            });
        }
    });

    function updateUnitPrice(selectElement) {
        const productId = selectElement.value;
        if (!productId) return;
        
        // 현재 폼 찾기
        const formRow = selectElement.closest('.form-row') || selectElement.closest('tr') || selectElement.closest('div');
        const unitPriceInput = formRow.querySelector('.unit-price-input');
        
        if (!unitPriceInput) return;
        
        // AJAX 요청으로 제품 가격 가져오기
        fetch(`/get-product-price/${productId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.price !== undefined) {
                    unitPriceInput.value = data.price;
                    calculateRowTotal(formRow); // 단가 업데이트 후 합계 재계산
                }
            })
            .catch(error => console.error('제품 가격을 가져오는 중 오류 발생:', error));
    }
    
    // 한 행의 합계 계산
    function calculateRowTotal(row) {
        const quantityInput = row.querySelector('input[name$="-quantity"]');
        const unitPriceInput = row.querySelector('input[name$="-unit_price"]');
        const totalElement = row.querySelector('.total-price');
        
        if (quantityInput && unitPriceInput && totalElement) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const total = quantity * unitPrice;
            
            // 천 단위 구분자로 표시
            totalElement.textContent = total.toLocaleString('ko-KR');
        }
    }
    
    // 모든 행의 합계 계산
    function calculateAllTotals() {
        const rows = document.querySelectorAll('.material-form');
        rows.forEach(row => calculateRowTotal(row));
    }
    
    // 전체 재료비 계산 후 작업정보 섹션의 재료비 입력란에 설정
    function calculateTotalMaterialCost() {
        const totalElements = document.querySelectorAll('.material-form:not(.d-none) .total-price');
        let totalCost = 0;
        
        totalElements.forEach(element => {
            // 천 단위 구분자 제거 후 숫자로 변환
            const value = element.textContent.replace(/,/g, '');
            totalCost += parseFloat(value) || 0;
        });
        
        // 작업정보 섹션의 재료비 입력란에 값 설정
        const materialCostField = document.querySelector('#id_material_cost');
        if (materialCostField) {
            materialCostField.value = totalCost;
            
            // 총 재료비 표시 업데이트
            const totalMaterialDisplay = document.querySelector('#total-material-display');
            if (totalMaterialDisplay) {
                totalMaterialDisplay.textContent = totalCost.toLocaleString('ko-KR');
            }
            
            // 입력 변경 이벤트 발생 (다른 계산이 필요한 경우)
            const event = new Event('input', { bubbles: true });
            materialCostField.dispatchEvent(event);
        }
    }
    
    // 총 금액(재료비+공임) 계산 및 표시
    function updateGrandTotal() {
        const materialCostField = document.querySelector('#id_material_cost');
        const laborCostField = document.querySelector('#id_labor_cost');
        
        let materialCost = 0;
        let laborCost = 0;
        
        if (materialCostField) {
            materialCost = parseFloat(materialCostField.value) || 0;
        }
        
        if (laborCostField) {
            laborCost = parseFloat(laborCostField.value) || 0;
            // 공임 금액 표시 업데이트
            const laborCostDisplay = document.querySelector('#labor-cost-display');
            if (laborCostDisplay) {
                laborCostDisplay.textContent = laborCost.toLocaleString('ko-KR');
            }
        }
        
        const grandTotal = materialCost + laborCost;
        const grandTotalDisplay = document.querySelector('#grand-total-display');
        if (grandTotalDisplay) {
            grandTotalDisplay.textContent = grandTotal.toLocaleString('ko-KR') + '원';
        }
    }
</script>
{% endblock %}